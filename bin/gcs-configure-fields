#!/usr/bin/env node

var CLI = require(__dirname + '/../lib/command-line').CommandLineInterface;
var commandLine = new CLI();

commandLine
  .usage('--name <field name> --type <field type> [options]')
  .option('--name <field name>',
          'The name of the field you are configuring or deleting. Required.',
          String)
  .option('--type <field type>',
          'The type of the field that you are configuring or deleting: ' +
            'text, literal, uint. Required.',
          String)
  .option('--option <option>',
          'Configures an option for the field specified by the --name and ' +
          '--type options. Valid values: search, nosearch, facet, nofacet, ' +
          'result, noresult. Text and literal fields cannot have both the ' +
          'facet and result options enabled. By default, text and uint ' +
          'fields are always searchable and uint fields are always ' +
          'facet-enabled.',
          String)
  .option('-d, --domain-name <domain name>',
          'The name of the domain that you are configuring. Required.',
          String)
  .option('--delete',
          'Delete the field specified by the --name and --type options.')
  .option('-f, --force', /* this is an extension of gcs-command */
          'Delete the domain without prompting for confirmation.')
  .parse();

commandLine.assertHaveDomainName();
commandLine.assertDomainExists();

if (!commandLine.options.name) {
  console.log('You must specify the field name.');
  return process.exit(1);
}

var field = commandLine.domain.getIndexField(commandLine.options.name);

var option = commandLine.options.option;
if (typeof option != 'string')
  option = null;

if (commandLine.options.delete) {
  if (!field.exists()) {
    console.log('You must specify an existing field.');
    return process.exit(1);
  }
  var doDelete = function() {
    field.deleteSync();
    console.log('Updated 1 Index Field:');
  };
  if (commandLine.options.force) {
    doDelete();
  } else {
    commandLine.confirm('Really delete? [' + field.name + '] (y/N) ', function(ok){
      if (ok) {
        doDelete();
        process.exit(0);
      } else {
        process.exit(1);
      }
    });
  }
} else {
  if (!field.exists()) {
    if (!commandLine.options.type) {
      console.log('You must specify the field type.');
      return process.exit(1);
    }
    field.type = commandLine.options.type;
  } else if (!option) {
    console.log('You must specify the configuring option.');
    return process.exit(1);
  }

  if (option) {
    try {
      switch (option) {
        case 'search':   field.searchEnabled = true;  break;
        case 'nosearch': field.searchEnabled = false; break;
        case 'facet':    field.facetEnabled =  true;  break;
        case 'nofacet':  field.facetEnabled =  false; break;
        case 'result':   field.resultEnabled = true;  break;
        case 'noresult': field.resultEnabled = false; break;
        default:
          throw new Error('invalid field option ' + option);
      }
    } catch(error) {
      console.log((error.message || error).toString());
      return process.exit(1);
    }
  }

  if (!field.exists())
    field.createSync();
  else
    field.saveOptionsSync();

  console.log('Updated 1 Index Field:');
  console.log(field.summary);
}
